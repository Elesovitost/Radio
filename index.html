<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

<link rel="stylesheet" href="styles.css">

</head>

<body class="bodyINDEX">



<div id="background-wrapper">
	<div id="random-background" class="background-image"></div>
	<div id="chessboard-overlay"></div>
</div>


<div id="SEG1" class="headerBar">

	
        <div class="dropdown">
            <button class="dropbtn">PET/CT</button>
            <div class="dropdown-content">
                <a href="#" onclick="changePage('FDGPET.html')">PET/CT/MR trupu</a>
                <a href="#" onclick="changePage('NaFskelet.html')">PET/CT NaF skeletu</a>
            </div>
        </div>

        <div class="dropdown">
            <button class="dropbtn">MR</button>
            <div class="dropdown-content">
                <a href="#" onclick="changePage('MRmozku.html')">MR mozku</a>
                <a href="#" onclick="changePage('MRBrainAngio.html')">MR angiografie</a>
                <a href="#" onclick="changePage('MRORL.html')">MR ORL</a>
                <div style="height: 10px;"></div>
				<a href="#" onclick="changePage('MRWB.html')">MR celotƒõlo</a>
				<div style="height: 10px;"></div>
                <a href="#" onclick="changePage('MRrekta.html')">MR rekta</a>
                <a href="#" onclick="changePage('MRprostaty.html')">MR prostaty</a>
                <a href="#" onclick="changePage('MRcervix.html')">MR cervixu</a>
                <a href="#" onclick="changePage('MRbreast.html')">MR prsu</a>
                <div style="height: 10px;"></div>
                <a href="#" onclick="changePage('MRCP.html')">MR C p√°te≈ôe</a>
                <a href="#" onclick="changePage('MRTP.html')">MR T p√°te≈ôe</a>
                <a href="#" onclick="changePage('MRLP.html')">MR L p√°te≈ôe</a>
                <a href="#" onclick="changePage('MRSIS.html')">MR SIS</a>
                <div style="height: 10px;"></div>
                <a href="#" onclick="changePage('MRzapesti.html')">MR z√°pƒõst√≠</a>
				<a href="#" onclick="changePage('MRramene.html')">MR ramene</a>
                <a href="#" onclick="changePage('MRkycle.html')">MR kyƒçle</a>
                <a href="#" onclick="changePage('MRkolene.html')">MR kolene</a>
                <a href="#" onclick="changePage('MRankle.html')">MR hlezna</a>
            </div>
        </div>

        <div class="dropdown">
            <button class="dropbtn">CT</button>
            <div class="dropdown-content">
                <a href="#" onclick="changePage('CTmozku.html')">CT mozku</a>
				<a href="#" onclick="changePage('CTWB.html')">CT celotƒõlo</a>
            </div>
        </div>

        <div class="dropdown">
            <button class="dropbtn">UZ</button>
            <div class="dropdown-content">
                <a href="#" onclick="changePage('UZcarotid.html')">UZ karotid</a>
                <a href="#" onclick="changePage('UZrenal.html')">UZ ren√°ln√≠ch tepen</a>
                <a href="#" onclick="changePage('UZthyroid.html')">UZ ≈°t√≠tn√© ≈æl√°zy</a>
                <a href="#" onclick="changePage('UZabdomen.html')">UZ b≈ôicha</a>
            </div>
        </div>

        <div class="dropdown">
            <button class="dropbtn">RTG</button>
            <div class="dropdown-content">
                <a href="#" onclick="changePage('RTGpre.html')">RTG p≈ôeddefinovan√©</a>
                <a href="#" onclick="changePage('RTGchest.html')">RTG plic</a>
            </div>
        </div>

		<!-- Prav√° skupina: TNM a PDF -->
		<div style="float: right; margin-right: 0px;">

			<div class="dropdown">
			  <button class="button60 dropbtn">HELPER</button>
			  <div class="dropdown-content">
				<a href="#" onclick="changePage('TNMORL.html')">TNM ORL</a>
				<a href="#" onclick="changePage('TNMRectum.html')">TNM rektum</a>
				<a href="#" onclick="changePage('TNMmiProstate.html')">TNM prostata</a>
				<a href="#" onclick="changePage('TNMCervix.html')">TNM cervix</a>
				<div style="height: 8px; border-top: 1px solid #aaa; margin: 6px 0;"></div>
				<a href="#" onclick="changePage('BTIT.html')">BT-IT</a>
			  </div>
			</div>

			<div class="dropdown" style="display: inline-block;">
				<button id="btnPDF" class="button60 dropbtn">üìÇPDF</button>
			</div>
		</div>

		<input type="file" id="pdfFileInput" accept=".pdf,.docx" style="display: none;">

	
</div>


<div id="promptSelectExam" class="noticeBar">VYBER TYP VY≈†ET≈òEN√ç...   <span class="bouncingPointer">üëÜ</span> </div>

<div id="page-container">
</div>

<span style="display: inline-block; height: 10px; width: 100%;"></span>

<div style="display:none;">
&nbsp; N√ÅZEV <button id="copyNAME" class="buttonTEXT">COPY</button>
<textarea id="FINALNAMEText" class="FINALXXL" readonly></textarea>

&nbsp; INDIKACE <button id="copyIND" class="buttonTEXT">COPY</button>
<textarea id="FINALINDText" class="FINALXXL" readonly></textarea>

&nbsp; SEKVENCE <button id="copySEKV" class="buttonTEXT">COPY</button>
<textarea id="FINALSEKVText" class="FINALXXL" readonly></textarea>

</div>


<div id="texty1" class="standardwidthFinalText" style="display: none;" >
<textarea id="FINALPOPText" class="FINALXXL" readonly></textarea>
<textarea id="FINALRESText" class="FINALXXL" readonly></textarea>
</div>

<div id="texty2" class="standardwidthFinalText" style="display: ; position: relative; "> 

<div style="display: flex; justify-content: space-between; align-items: center; padding: 0 12px;">
  
  <!-- Lev√° skupina -->
  <div style="display: flex; gap: 4px;">
    <button id="copyCOMP" class="buttonCLICK">üìã KOMPLET</button> 
    <button id="copyPOP" class="buttonCLICK">üìã POPIS</button> 
    <button id="copyRES" class="buttonCLICK">üìã Z√ÅVƒöR</button> 
  </div>

  <!-- Prav√° skupina -->
  <div style="display: flex; gap: 4px;">
    <button id="toggleEdit" class="buttonCLICK">üìù EDIT</button>
    <button id="checkAI" class="buttonCLICK">üîç AI</button>
    <button id="saveButton" class="buttonCLICK">üíæ SAVE</button>
    <button id="loadButton" class="buttonCLICK">üìÇ LOAD</button>
  </div>

</div>


  <div id="popupMessage" style="display:none; position:relative; background-color:white; padding:10px; z-index:100; border:1px solid black; font-size:14px; text-transform: uppercase; font-weight: bold; width:300px;">
  </div>

  <textarea id="FINALCOMPLETEText" class="FINALXXL" readonly></textarea>
  
<div id="aiResult" class="standardwidthFinalText" style="margin-top: 10px; display: none;">
  <div style="font-size: 14px; margin-bottom: 0px;">
	<button id="AIresult" class="buttonTEXT">üìã AI CHECK</button>
  <pre id="aiOutput" style="white-space: pre-wrap; background: #f7f7f7; padding: 4px; border: 1px solid #ccc; font-size: 12px; line-height: 1.0;"></pre>
  </div>
</div>


</div>


<div id="helpOverlay" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;">
  <div style="position:absolute;top:10%;left:10%;width:80%;height:80%;background:#fff;border:1px solid #000;padding:10px;box-sizing:border-box;">
    <button class="remove-button" style="position:absolute;top:2px;left:2px;" onclick="document.getElementById('helpOverlay').style.display='none'">X</button>
    <textarea id="backupViewer" readonly style="width:100%;height:100%;box-sizing:border-box;resize:none;overflow:auto;"></textarea>
  </div>
</div>



<svg width="0" height="0">
<filter id="bubbleFilter">
  <feTurbulence type="fractalNoise" baseFrequency="0.02" numOctaves="1" result="turbulence">
	<animate attributeName="baseFrequency" values="0.005;0.001;0.003;0.001;0.005" dur="60s" repeatCount="indefinite"/>
  </feTurbulence>
  <feDisplacementMap in="SourceGraphic" in2="turbulence" scale="40" xChannelSelector="R" yChannelSelector="G"/>
</filter>
</svg>



<script>



document.addEventListener('DOMContentLoaded', function() {
    setupRefreshOnAction(document);

    var container = document.getElementById("page-container");
    var iframes = container.getElementsByTagName("iframe");
    for (var i = 0; i < iframes.length; i++) {
        bindEventsToIframe(iframes[i]);
    }

    var textareas = document.querySelectorAll('.FINALXXL');
    textareas.forEach(adjustTextareaHeight);

	checkAndUpdateDivVisibility(); // Immediate check
	setupRefreshOnAction(document);
});


function adjustTextareaHeight(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

function changePage(url) {
    var container = document.getElementById("page-container");
    var uniqueId = "iframe-" + url + "-" + Date.now();

    var iframeContainer = document.createElement("div");
    iframeContainer.className = "iframe-container";

    var iframe = document.createElement("iframe");
    iframe.id = uniqueId;
    iframe.src = url;
    iframe.style.width = "100%";
    iframe.style.border = "none";
    iframe.style.opacity = 0; // Initially invisible
    iframe.onload = function() {
        iframe.style.height = "0px";
        try {
            adjustIframeHeight(iframe);
            bindEventsToIframe(iframe);
            updateFinalTextAreas();
            checkAndUpdateDivVisibility();

            // Delay the fade-in animation until the iframe is loaded
            setTimeout(() => {
                iframe.style.opacity = 1; // Make the iframe visible
				const bg = document.getElementById('random-background');
				if (bg) {
					bg.style.opacity = 0.3;
					bg.style.filter = 'blur(4px)';
				}
                iframe.classList.add('iframe-fade-in');
            }, 100); // Short delay before fade-in starts
			
            setTimeout(() => {
                iframe.classList.remove('iframe-fade-in');
            }, 1100); // Duration of the animation plus initial delay
        } catch (e) {
            console.log('Error in iframe onload:', e);
        }
    };

    var removeButton = document.createElement("button");
    removeButton.textContent = "X";;
    removeButton.className = "remove-button"; 
	
		removeButton.onclick = function() {
			container.removeChild(iframeContainer);
			// Skryj v√Ωstup AI po zav≈ôen√≠ okna
			document.getElementById("aiResult").style.display = "none";

			if (container.children.length === 0) {
				const bg = document.getElementById('random-background');
				if (bg) {
					// Naƒçten√≠ nov√©ho n√°hodn√©ho obr√°zku p≈ôed zv√Ω≈°en√≠m opacity
					const randomIndex = Math.floor(Math.random() * 6) + 1;
					bg.style.backgroundImage = `url('background/${randomIndex}.webp')`;
					bg.style.opacity = 1;
				}
				resetBackgroundFilter();
				// Zav≈ô√≠t PDF viewer, pokud je otev≈ôen√Ω
				const pdfViewer = document.getElementById('doc-viewer');
				if (pdfViewer) {
					pdfViewer.remove();
				}
			}
		};

    iframeContainer.appendChild(removeButton);
    iframeContainer.appendChild(iframe);
    container.appendChild(iframeContainer);
}


function adjustIframeHeight(iframe) {
    var observer = new MutationObserver(function() {
        updateIframeHeight(iframe);
    });

    observer.observe(iframe.contentWindow.document.body, {
        attributes: true,
        childList: true,
        subtree: true
    });

    updateIframeHeight(iframe);
}

function updateIframeHeight(iframe) {
    // Remember the current scroll position
    var scrollTop = window.pageYOffset || document.documentElement.scrollTop;

    iframe.style.height = '0px';
    var minHeight = 10; // Minimum height
    var iframeContentHeight = iframe.contentWindow.document.body.scrollHeight;
    iframe.style.height = Math.max(iframeContentHeight, minHeight) + 'px';

    // Restore the scroll position
    window.scrollTo(0, scrollTop);
}



function bindEventsToIframe(iframe) {
    try {
        var doc = iframe.contentWindow.document;
        setupRefreshOnAction(doc);
    } catch (e) {
        console.log('Error binding events to iframe:', e);
    }
}

function setupRefreshOnAction(doc) {
    function delayedUpdate(event) {
		if (editMode) return;
        // Add the IDs of the buttons to the condition
        if (event.target.id === 'FINALPOPText' || event.target.id === 'FINALRESText' || event.target.id === 'FINALCOMPLETEText' ||
            event.target.id === 'copyPOP' || event.target.id === 'copyRES' || event.target.id === 'copyCOMP') {
            // If the event target is one of the specified elements, skip the rest of the function
            return;
        }

        var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        var scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;

        setTimeout(function() {
            updateFinalTextAreas();
            checkAndUpdateDivVisibility();

            // Restore the scroll position
            window.scrollTo(scrollLeft, scrollTop);
        }, 1);
    }

    // Attach the event listeners to the document or passed document-like object (e.g., iframe's document)
    doc.addEventListener('keydown', delayedUpdate);
    doc.addEventListener('mouseup', delayedUpdate);
    doc.addEventListener('input', delayedUpdate);
    doc.addEventListener('wheel', delayedUpdate);
}



//P≈ô√≠prava text≈Ø s n√°zvy apod.

function updateFinalTextAreas() {
	if (editMode) return;
    var container = document.getElementById("page-container");
    var iframes = container.getElementsByTagName("iframe");
    
    var finalNAMEText = '';
    var finalINDText = '';
    var finalSEKVText = '';
    var finalPOPText = '';
    var finalRESText = '';
    var nameTexts = []; // Array to hold NAMEText values
    var popTexts = []; // Array to hold POPText values


    for (var i = 0; i < iframes.length; i++) {
        var iframe = iframes[i];
        try {
            var doc = iframe.contentWindow.document;
            
            // Extract NAMEText and store in array
            var nameTextAreas = doc.querySelectorAll("textarea[id$='NAMEText']");
            for (var j = 0; j < nameTextAreas.length; j++) {
                finalNAMEText += nameTextAreas[j].value + ", ";
                nameTexts.push(nameTextAreas[j].value); // Add to array
            }

            // Extract INDText
            var indTextAreas = doc.querySelectorAll("textarea[id$='INDText']");
            for (var j = 0; j < indTextAreas.length; j++) {
                if (indTextAreas[j].value.trim() !== "") {
                    finalINDText += (finalINDText ? ", " : "") + indTextAreas[j].value;
                }
            }

            // Extract SEKVText
            var sekvTextAreas = doc.querySelectorAll("textarea[id$='SEKVText']");
            for (var j = 0; j < sekvTextAreas.length; j++) {
                finalSEKVText += sekvTextAreas[j].value;
            }

            // Extract POPText and store in array
            var popTextAreas = doc.querySelectorAll("textarea[id$='POPText']");
            for (var j = 0; j < popTextAreas.length; j++) {
                popTexts.push(popTextAreas[j].value); // Add to array without modification
            }

            // Extract RESText
            var resTextAreas = doc.querySelectorAll("textarea[id$='RESText']");
            for (var j = 0; j < resTextAreas.length; j++) {
                finalRESText += resTextAreas[j].value + "\n";
            }

        } catch (e) {
            console.log('Error accessing iframe contents:', e);
        }
    }
	
	
    // Prepend NAMEText to corresponding POPText if more than one NAMEText
    if (nameTexts.length > 1) {
        finalPOPText = nameTexts.map((name, index) => name + ":\n" + (popTexts[index] || "")).join("\n \n");
    } else {
        finalPOPText = popTexts.join("\n\n"); // Use as is if only one POPText
    }

	// Check if compText contains "PSMA-PET/CT" and replace "MR" with "PSMA-PET/MR, same for FDG-PET"
	if (finalPOPText.includes("FDG-PET/CT")) {
		finalPOPText = finalPOPText.replace(/(?:^|, )MR/gm, function(match) {
			return match === 'MR' ? "FDG-PET/MR" : ", FDG-PET/MR";
		});
	}
	else if (finalPOPText.includes("PSMA-PET/CT")) {
		finalPOPText = finalPOPText.replace(/(?:^|, )MR/gm, function(match) {
			return match === 'MR' ? "PSMA-PET/MR" : ", PSMA-PET/MR";
		});
	}

    // Update final text areas
    document.getElementById("FINALNAMEText").value = finalNAMEText.slice(0, -2).trim();
    document.getElementById("FINALINDText").value = finalINDText.trim();
    document.getElementById("FINALSEKVText").value = finalSEKVText.trim();
    document.getElementById("FINALPOPText").value = finalPOPText.trim();
    document.getElementById("FINALRESText").value = finalRESText.trim();

    // Combine into FINALCOMPLETEText
    var finalCompleteText = finalNAMEText.slice(0, -2);

//    if (finalSEKVText.trim()) {
//        finalCompleteText += "\n\nSekvence: " + finalSEKVText.trim();
//    }

    if (finalINDText.trim()) {
        finalCompleteText += (finalCompleteText ? "\n\n" : "") + "Indikace: " + finalINDText.trim();
    }

    finalCompleteText += "\n\n" + finalPOPText.trim() + "\n\n" + "Z√°vƒõr: " + "\n" + finalRESText.trim();

    document.getElementById("FINALCOMPLETEText").value = finalCompleteText.trim();
}	




function checkAndUpdateDivVisibility() {
    var popText = document.getElementById("FINALPOPText").value.trim();
    var resText = document.getElementById("FINALRESText").value.trim();
	var compText = document.getElementById("FINALCOMPLETEText").value.trim();
    var div = document.getElementById("texty1");
	var div2 = document.getElementById("texty2");

    if (popText === '' && resText === '') {
        div.classList.add('invisible'); div2.classList.add('invisible');
		div.classList.remove('visible'); div2.classList.remove('visible');
    } else {
        div.classList.add('visible'); div2.classList.add('visible')
		div.classList.remove('invisible'); div2.classList.remove('invisible')
    }
	
	adjustTextareaHeight(document.getElementById("FINALPOPText"));
    adjustTextareaHeight(document.getElementById("FINALRESText"));
	adjustTextareaHeight(document.getElementById("FINALCOMPLETEText"));
	
	const promptBox = document.getElementById("promptSelectExam");
	const pageContent = document.getElementById("page-container");

	if (pageContent.children.length === 0) {
	  promptBox.style.display = "block";
	} else {
	  promptBox.style.display = "none";
	}

}

function adjustTextareaHeight(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}



// COPY and blink

function highlightTextInTextarea(textareaId, textToHighlight) {
    const textarea = document.getElementById(textareaId);
    const fullText = textarea.value;

    const startIndex = fullText.indexOf(textToHighlight);
    if (startIndex === -1) return;

    const endIndex = startIndex + textToHighlight.length;

    textarea.focus();
    textarea.setSelectionRange(startIndex, endIndex);

    // Automaticky zru≈°√≠ v√Ωbƒõr po 400 ms
    setTimeout(() => {
        textarea.setSelectionRange(0, 0);
    }, 400);
}


document.addEventListener('DOMContentLoaded', () => {

    function showPopup(message) {
        const popup = document.getElementById('popupMessage');
        popup.textContent = message;
        popup.style.display = 'block';
        setTimeout(() => popup.style.display = 'none', 2000);
    }

    function validateText(text) {
        if (text.includes("MR kolene") || text.includes("MR ramene") || text.includes("MR hlezna")) {
            showPopup("DOPL≈á STRANU");
            return false;
        }

        const invalidCombo =
            (text.includes("FDG") && text.includes("PSMA")) ||
            (text.includes("FDG") && text.includes("DOTATOC")) ||
            (text.includes("PSMA") && text.includes("DOTATOC"));

        if (invalidCombo) {
            showPopup("NEP≈ò√çPUSTN√Å KOMBINACE RADIOFARMAK");
            return false;
        }

		if (/(?:^|\n)CT\s*$/m.test(text)) {
			showPopup("DOPL≈á ROZSAH VY≈†ET≈òEN√ç");
			return false;
		}

        return true;
    }

	  function copyTextAndBlink(text, targetTextareaId) {
		if (!validateText(text)) return;

		navigator.clipboard.writeText(text)
			.then(() => {
				console.log("Text copied:", text);
				highlightTextInTextarea(targetTextareaId, text); // pou≈æijeme v√Ωbƒõr, ne animaci
			})
			.catch(err => {
				console.error("Copy failed:", err);
			});
	}


    // Setup copy buttons
    document.getElementById('copyCOMP').addEventListener('click', () => {
        const text = document.getElementById("FINALCOMPLETEText").value;
        copyTextAndBlink(text, "FINALCOMPLETEText");
    });

    document.getElementById('copyPOP').addEventListener('click', () => {
		const text = document.getElementById("FINALCOMPLETEText").value;
		let lines = text.split('\n');
		lines.shift(); // remove name

		let sekvIndex = lines.findIndex(line => line.trim().startsWith("Sekvence:"));
		if (sekvIndex !== -1) lines.splice(sekvIndex, 2);

		let indIndex = lines.findIndex(line => line.trim().startsWith("Indikace:"));
		if (indIndex !== -1) lines.splice(indIndex, 2);

		let zavIndex = lines.findIndex(line => line.trim() === "Z√°vƒõr:");
		if (zavIndex !== -1) lines = lines.slice(0, zavIndex);

		const finalPop = lines.join('\n').trim();
		copyTextAndBlink(finalPop, "FINALCOMPLETEText");
		highlightTextInTextarea("FINALCOMPLETEText", finalPop); // p≈ôid√°no
	});	

	document.getElementById('copyRES').addEventListener('click', () => {
		const text = document.getElementById("FINALCOMPLETEText").value;
		const match = text.match(/Z√°vƒõr:\s*\n([\s\S]*)$/);
		const finalRes = match ? match[1].trim() : "";
		copyTextAndBlink(finalRes, "FINALCOMPLETEText");
		highlightTextInTextarea("FINALCOMPLETEText", finalRes); // p≈ôid√°no
	});
	
});



// SAVE button handler
document.getElementById('saveButton').addEventListener('click', function () {
  const text = document.getElementById('FINALCOMPLETEText').value;
  const trimmed = text.trim();
  const blob = new Blob([trimmed], { type: 'text/plain' });

  // vytvo≈ôen√≠ timestampu
  const now = new Date();
  const datePart = now.toISOString().split("T")[0].replace(/-/g, '');       // YYYYMMDD
  const timePart = now.toTimeString().split(" ")[0].replace(/:/g, '');      // HHMMSS
  const filename = `${datePart}-${timePart}-radio-popis.txt`;

  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;

  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  if (trimmed) {
    appendToLocalStorageLog(trimmed, " (ruƒçnƒõ)");
  }

  lastSavedText = trimmed;
});



// check AI

const btn = document.getElementById('checkAI');
if (btn) {
  btn.addEventListener('click', () => {
    // P≈ôeƒçteme obsah viditeln√© textarea FINALCOMPLETEText
    const textareaCOMP = document.getElementById('FINALCOMPLETEText');
    const completeText = textareaCOMP ? textareaCOMP.value.trim() : "";

    //alert("üì§ Text odeslan√Ω do AI:\n\n" + completeText);

    zkontrolujAI(completeText);
  });
}

async function zkontrolujAI(completeText) {
  const output = document.getElementById('aiOutput');
  const resultDiv = document.getElementById('aiResult');

  if (!completeText) {
    alert("Text je pr√°zdn√Ω.");
    return;
  }

  output.innerText = "‚è≥ AI analyzuje...";
  resultDiv.style.display = 'block';

  // Ode≈°leme JSON s polem 'text'
  try {
    const response = await fetch("https://radio-ai-backend.onrender.com/api/check", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: completeText })
    });

    const data = await response.json();
    output.innerText = data.result || "‚ö†Ô∏è ≈Ω√°dn√° odpovƒõƒè od AI.";
  } catch (error) {
    output.innerText = "‚ùå Chyba p≈ôipojen√≠: " + error.message;
  }
}



	// EDIT m√≥d

let editMode = false;

document.getElementById('toggleEdit').addEventListener('click', () => {
  const textareaIDs = ["FINALPOPText", "FINALRESText", "FINALCOMPLETEText"];
  editMode = !editMode;

  textareaIDs.forEach(id => {
    const el = document.getElementById(id);
    el.readOnly = !editMode;
    el.style.backgroundColor = editMode ? "#fffceb" : ""; // jemnƒõj≈°√≠ ≈ælut√°
  });

  const toggleBtn = document.getElementById('toggleEdit');
  toggleBtn.textContent = editMode ? "Zru≈°it EDIT" : "üìù EDIT";
  toggleBtn.style.backgroundColor = editMode ? "#ffe0b3" : ""; // jemn√° oran≈æov√°

  const page = document.getElementById('page-container');
  if (page) {
    page.style.pointerEvents = editMode ? "none" : "";
    page.style.opacity = editMode ? "0.2" : "";
  }

  // Pokud se pr√°vƒõ ukonƒçuje re≈æim editace, ulo≈æ do LocalStorage
  if (!editMode) {
    const text = document.getElementById('FINALCOMPLETEText').value.trim();
    if (text && text !== lastSavedText) {
      appendToLocalStorageLog(text, " (po EDITACI)");
      lastSavedText = text;
    }
  }
});




//PDF open

document.getElementById('btnPDF').addEventListener('click', function() {
    document.getElementById('pdfFileInput').click();
});

document.getElementById('pdfFileInput').addEventListener('change', function(event) {
    var file = event.target.files[0];
    if (!file) return;

    // Vytvo≈ôen√≠ URL vybran√©ho souboru
    var fileURL = URL.createObjectURL(file);

    // Vytvo≈ôen√≠ kontejneru pro zobrazen√≠ dokumentu
    var docContainer = document.createElement('div');
    docContainer.id = 'doc-viewer';
    // Um√≠stƒõn√≠: napravo od page-container ‚Äì upravte podle pot≈ôebn√©ho layoutu
    docContainer.style.position = 'fixed';
    docContainer.style.top = '100px';
    docContainer.style.right = '20px';
    docContainer.style.width = '40%';
    docContainer.style.height = '80%';
    docContainer.style.border = '1px solid #ccc';
    docContainer.style.backgroundColor = '#fff';

    // Vytvo≈ôen√≠ iframe pro zobrazen√≠ dokumentu
    var iframe = document.createElement('iframe');
    iframe.src = fileURL;
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    iframe.style.border = 'none';

	var removeBtn = document.createElement('button');
	removeBtn.textContent = 'X';
	removeBtn.className = 'remove-button'; // pou≈æije se existuj√≠c√≠ styl pro odebr√°n√≠ (ƒçerven√© tlaƒç√≠tko)
	removeBtn.style.position = 'absolute';
	removeBtn.style.top = '0';
	removeBtn.style.left = '0';  // Upraveno na lev√Ω horn√≠ roh
	removeBtn.style.zIndex = '10';

	removeBtn.addEventListener('click', function() {
		if (docContainer) {
			docContainer.parentNode.removeChild(docContainer);
		}
	});

    docContainer.appendChild(removeBtn);
    docContainer.appendChild(iframe);

    // P≈ôid√°n√≠ kontejneru do dokumentu (m≈Ø≈æete upravit um√≠stƒõn√≠ dle pot≈ôeby)
    document.body.appendChild(docContainer);
});
	
	
// local storage backup

// P≈òID√Å NOV√ù Z√ÅZNAM A UDR≈Ω√ç POUZE POSLEDN√çCH 10
function appendToLocalStorageLog(text, prefix = "") {
  const key = "radioBackup";
  const now = new Date();
  const today = now.toISOString().split("T")[0];
  const time = now.toTimeString().split(" ")[0];

  let data = localStorage.getItem(key);
  let parsed = { date: today, logs: [] };

  if (data) {
    try {
      parsed = JSON.parse(data);
      if (parsed.date !== today) parsed = { date: today, logs: [] };
    } catch (e) {
      parsed = { date: today, logs: [] };
    }
  }

  // P≈ôid√°n√≠ nov√©ho z√°znamu
  parsed.logs.push(`[${time}]${prefix}\n${text}\n\n---\n`);

  // Udr≈æen√≠ max. 20 z√°znam≈Ø
  if (parsed.logs.length > 20) {
    parsed.logs = parsed.logs.slice(-20);
  }

  localStorage.setItem(key, JSON.stringify(parsed));
}

// AUTOSAVE ka≈æd√Ωch 5 minut do localStorage s raz√≠tkem a denn√≠ rotac√≠

let lastSavedText = ""; // uchov√° posledn√≠ ulo≈æen√Ω text

setInterval(() => {
  if (editMode) return;

  const text = document.getElementById("FINALCOMPLETEText").value.trim();
  if (!text || text === lastSavedText) return;

  appendToLocalStorageLog(text);
  lastSavedText = text;
}, 10 * 60 * 1000);


//LOAD

document.getElementById("loadButton").addEventListener("click", function () {
  const overlay = document.getElementById("helpOverlay");
  const viewer = document.getElementById("backupViewer");

  try {
    const backup = JSON.parse(localStorage.getItem("radioBackup") || "{}");
    viewer.value = backup.logs ? backup.logs.join("\n") : "≈Ω√°dn√° data.";
  } catch (e) {
    viewer.value = "Chyba p≈ôi naƒç√≠t√°n√≠ z√°lohy.";
  }

  overlay.style.display = "block";
});



// background IMAGE


document.addEventListener('DOMContentLoaded', function () {
 const bgDiv = document.getElementById('random-background');
 if (bgDiv) {
	 const randomIndex = Math.floor(Math.random() * 7) + 1;
	 bgDiv.style.backgroundImage = `url('background/${randomIndex}.webp')`;
 }
 console.log("Naƒçten obr√°zek:", bgDiv.style.backgroundImage);
});


function resetBackgroundFilter() {
  const bg = document.getElementById('random-background');
  if (bg) {
	bg.style.opacity = 1;
	bg.style.filter = 'url(#bubbleFilter)';
  }
}

	
</script>



</body>

</html>

